#!/bin/sh

[[ -f "/etc/arch-release" ]] || echo "Warning! This is not an Arch Linux based system. Things may break.."

[[ -z "${USER}" ]] && USER=$(whoami)
HOME=$(getent passwd "${USER}" | cut -d: -f6)
GIT_HOME="${HOME}/.git"


echo 'Updating system..'
pacman \
  --sync \
  --refresh \
  --sysupgrade \
  --needed \
  --noconfirm
  
echo 'Installing setup dependencies..'
pacman \
  --sync \
  --needed \
  --noconfirm \
  git rsync curl openssh 
  
groupadd \
  --force \
  --gid 100 \
  users
  
useradd \
  --create-home \
  --no-user-group \
  $USER
  
[[ -z $(git --git-dir ${GIT_HOME} status -s) ]] || echo "${HOME} is not clean! exiting.."; exit 1

TMP_DOTFILES=$(mktemp --directory)

git clone https://github.com/simonwjackson/dotfiles.git ${TMP_DOTFILES}

rm -rdf "${GIT_HOME}"
rsync --verbose --archive --recursive ${TMP_DOTFILES}/ ${HOME}

rm -rdf ${TMP_DOTFILES}
